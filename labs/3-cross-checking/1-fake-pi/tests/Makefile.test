# Testing helper makefile
#
# Usage (called from parent Makefile with TESTS variable set):
#   - make runall    : run all programs in TESTS
#   - make emitall   : generate .out files for all programs
#   - make checkall  : check all programs against their .out files
#   - make cksumall  : compute checksums for all programs
#   - make refall    : copy .out to .ref files

MAKEFLAGS += --no-print-directory

# Only extract lines containing TRACE:
# GREP_STR := "TRACE:"
GREP_STR := 'TRACE:\|ERROR:\|PANIC:'


ifndef TESTS
$(error TESTS is not defined: makefile invoked incorrectly)
endif

# Generate phony target names from TESTS
TEST_RUN   := $(TESTS:.fake=.run)
TEST_CHECK := $(TESTS:.fake=.check)
TEST_CKSUM := $(TESTS:.fake=.cksum)
TEST_OUT   := $(TESTS:.fake=.out)
TEST_REF   := $(TESTS:.fake=.ref)

all: $(TEST_RUN)

# Run a single test program
%.run: %.fake
	@echo "\n-------------------<start>---------------------------------------"
	./$<
	@echo "-------------------<end>---------------------------------------"

# Generate reference output (.out file)
# Extracts only TRACE: lines from program output
%.out: %.fake
	@echo -n "generating <$*.out> and <$*.raw>: "
	@./$< 2>&1 > $*.raw || (echo "ERROR generating raw file:" && cat $*.raw && exit 1)
	@grep $(GREP_STR) $*.raw > $*.out
	@echo " success!"

# Copy .out to .ref (for creating reference files)
%.ref: %.out
	@cp $*.out $*.ref

# Check test output against reference
%.check: %.fake %.out
	@echo "------------------------------------------"
	@echo "checking $*:"
	@echo "  generating new test output <$*.test>"
	@./$< 2>&1 | grep $(GREP_STR) > $*.test
	@echo "  comparing <$*.test> to reference <$*.out>"
	@diff $*.out $*.test || (echo "ERROR: output mismatch, compare $*.test vs $*.out" && exit 1)
	@echo "  Success! Matched!"
	@rm -f $*.test

# Compute checksum of reference output
%.cksum: %.out
	@cksum $*.out

# Aggregate targets (run checks for all tests)
emitall: $(TEST_OUT)
checkall: $(TEST_CHECK)
runall: $(TEST_RUN)
cksumall: $(TEST_CKSUM)
refall: $(TEST_REF)
	@echo "created ref files: $(TEST_REF)"

print:
	@echo "TEST_RUN = $(TEST_RUN)"
	@echo "TEST_CHECK = $(TEST_CHECK)"
	@echo "TEST_OUT = $(TEST_OUT)"

cleanall:
	rm -f *.out *.raw *.test

# Keep .out files (don't delete as intermediate files)
.PRECIOUS: $(TEST_OUT)

.PHONY: all cleanall runall emitall checkall cksumall refall print
